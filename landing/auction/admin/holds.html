<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin • Holds to chase</title>
  <link rel="icon" href="/assets/app-icon.png"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>

  <style>
    :root{color-scheme:dark}
    *{box-sizing:border-box}
    html,body{background:#0b1220;color:#e5eaf3;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
    a{color:#7dd3fc}
    .wrap{max-width:1368px;margin:24px auto;padding:0 16px}
    .card{background:#0f172a;border:1px solid #20283a;border-radius:16px;padding:16px}
    h1{font-size:22px;margin:0 0 12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{font:inherit}
    .in{padding:10px 12px;border:1px solid #2b2f3a;border-radius:10px;background:#0b1220;color:#e5eaf3}
    .in[readonly]{opacity:.8}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #2b2f3a;cursor:pointer;font-weight:600;transition:.15s}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.primary{background:#22d3ee;color:#00131a;border-color:#3ddbf1;box-shadow:0 1px 0 #0ea5b711 inset}
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.sec{background:#1e293b;border-color:#334155;color:#e5eaf3}
    .btn.sec:hover{background:#223148}
    .btn.ghost{background:#142036;border-color:#2a3a57;color:#cfe1ff}
    .btn.ghost:hover{background:#1a2a46}
    .btn.pill{border-radius:999px;padding:8px 12px}
    .badge{padding:3px 8px;border-radius:999px;background:#0b1220;border:1px solid #233049}
    .muted{opacity:.85}
    .mini{font-size:12px;opacity:.75}
    .hr{height:1px;background:#1f2736;margin:12px 0}
    .nowrap{white-space:nowrap}
    .copy{cursor:pointer;border-bottom:1px dashed #64748b}
    .kpi{min-width:160px}.kpi .v{font-weight:800;font-size:22px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grid2{display:grid;gap:12px;grid-template-columns:minmax(0,1fr) minmax(0,1fr)}
    .checkbox{width:18px;height:18px}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;display:inline-block}
    .tag.PF{background:#06b6d4;color:#001015}
    .tag.GF{background:#fde047;color:#2a2400}
    .tag.SE{background:#cbd5e1;color:#0b1220}
    .ok{color:#34d399}
    .warn{color:#fbbf24}
    .bad{color:#f87171}

    /* таблиця */
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;text-align:left;opacity:.8;padding:0 8px;position:sticky;top:0;background:#0b1220;z-index:5}
    thead .thbtn{cursor:pointer;user-select:none;border-radius:8px;padding:4px 6px;display:inline-flex;align-items:center;gap:6px}
    thead .thbtn:hover{background:#19233a}
    td{background:#0f172a;border:1px solid #20283a;padding:10px 8px;vertical-align:middle}
    tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}

    /* редактори */
    .edit{display:flex;gap:6px;align-items:center}
    .edit input[type="number"]{width:72px;text-align:center}
    .edit textarea{width:320px;min-height:34px;resize:vertical}

    /* графіки */
    canvas.chart{width:100%;display:block;border:1px solid #20283a;border-radius:8px;background:#0b1220}
    #chartTip{position:fixed;display:none;padding:8px 10px;border:1px solid #374151;border-radius:8px;background:#0b1220;pointer-events:none;box-shadow:0 6px 20px rgba(0,0,0,.35);font-size:12px}

    /* модалка */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.5);display:none;align-items:center;justify-content:center;z-index:50}
    .modal .box{background:#0f172a;border:1px solid #223049;border-radius:14px;padding:16px;min-width:340px;max-width:520px}
    .modal.show{display:flex}

    /* підсвічування активних фільтрів */
    .qs .btn.ghost.active{background:#0f2a4f;border-color:#3967a7;color:#e6f1ff}

    /* підказка гарячих клавіш у хедері */
    .hk{font-size:11px;opacity:.75}
  </style>
  <meta name="robots" content="noindex, nofollow, noarchive">
</head>
<body>
<div class="wrap">

  <!-- ========================= CONFIG ========================= -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <h1 style="margin:0">Holds to chase</h1>
      <div class="hk mini">Hotkeys: <strong>A</strong> = select all • <strong>P</strong> = ping • <strong>C</strong> = batch convert • <strong>Shift+клік</strong> = вибрати діапазон</div>
    </div>

    <div class="row" style="margin-top:6px">
      <input id="edge"  class="in" style="min-width:320px" placeholder="EDGE_URL (https://...functions.supabase.co)"/>
      <input id="anon"  class="in" style="min-width:320px" placeholder="SUPABASE_ANON_JWT"/>
      <input id="token" class="in" style="min-width:320px" placeholder="ADMIN_TOKEN (x-admin-token)"/>
    </div>

    <div class="row" style="margin-top:8px">
      <input id="minAge" class="in" type="number" value="10" style="width:120px" title="Мін. вік броні (хв)"/>
      <input id="limit"  class="in" type="number" value="200" style="width:120px" title="Скільки рядків завантажити"/>
      <button class="btn primary" id="saveLoad">Зберегти & Завантажити</button>
      <button class="btn sec" id="reload">Оновити</button>
      <div class="qs" style="display:flex;gap:6px;margin-left:auto">
        <span class="mini muted" style="padding-top:9px">Швидкий вибір:</span>
        <button class="btn ghost pill" data-qsel="clear">Жодного</button>
        <button class="btn ghost pill" data-qsel="all">Усі</button>
        <button class="btn ghost pill" data-qsel="pf">Лише PF</button>
        <button class="btn ghost pill" data-qsel="gf">Лише GF</button>
        <button class="btn ghost pill" data-qsel="se">Лише SE</button>
        <button class="btn ghost pill" data-qsel="pinged">Лише Pinged</button>
        <button class="btn ghost pill" data-qsel="notpinged">Лише Not pinged</button>
      </div>
    </div>

    <div class="hr"></div>
    <div class="row">
      <input id="q" class="in" placeholder="Пошук (email, hold_id)"/>
      <div class="mini muted">Порада: клацніть по email/hold_id, щоб скопіювати. URL синхронізує <code>?q=</code>.</div>
      <span id="status" class="muted mini" style="margin-left:auto"></span>
    </div>
  </div>

  <!-- ========================= DASHBOARD ========================= -->
  <div class="card" id="statsCard">
    <div class="toolbar" style="margin-bottom:8px">
      <strong>Статистика</strong>
      <input id="stFrom" class="in" type="date"/>
      <input id="stTo"   class="in" type="date"/>
      <button class="btn sec" id="st7">7д</button>
      <button class="btn sec" id="st30">30д</button>
      <button class="btn primary" id="stReload">Оновити статистику</button>
      <span id="stStatus" class="mini muted"></span>
    </div>

    <div class="row" id="statsBoxes" style="gap:10px">
      <div class="card kpi" style="padding:10px"><div class="mini muted">Holds</div><div id="stHolds" class="v">—</div></div>
      <div class="card kpi" style="padding:10px"><div class="mini muted">Pinged</div><div id="stPinged" class="v">—</div></div>
      <div class="card kpi" style="padding:10px"><div class="mini muted">Orders</div><div id="stOrders" class="v">—</div></div>
      <div class="card kpi" style="padding:10px"><div class="mini muted">Revenue</div><div id="stRevenue" class="v">—</div></div>
      <div class="card" style="padding:10px;min-width:240px">
        <div class="mini muted">Конверсія після ping</div>
        <div id="stConv" style="font-weight:800;font-size:20px">—</div>
        <div class="mini muted">середнє ≈ <span id="stAvg">—</span> хв</div>
      </div>
      <div class="card" style="padding:10px;min-width:240px">
        <div class="mini muted">Середній вік броні при конверсії</div>
        <div id="stAvgAge" style="font-weight:800;font-size:20px">—</div>
        <div class="mini muted" id="stRange" style="opacity:.75">—</div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="toolbar" style="align-items:center;gap:10px">
      <span class="mini muted">Групування:</span>
      <select id="stGroup" class="in">
        <option value="day">за днем</option>
        <option value="week">за тижнем</option>
      </select>

      <label class="mini"><input id="stStack" type="checkbox" class="checkbox"> Складені конверсії</label>
      <label class="mini"><input id="stAvgLine" type="checkbox" class="checkbox" checked> Середнє (дохід)</label>
      <label class="mini"><input id="stMedLine" type="checkbox" class="checkbox" checked> Медіана (дохід)</label>
      <label class="mini">MA вікно:
        <select id="stMA" class="in"><option>Off</option><option>7</option><option>14</option><option>28</option></select>
      </label>

      <div style="margin-left:auto"></div>
      <button class="btn sec" id="stPNG">Експорт PNG (обидва графіки)</button>
      <button class="btn sec" id="stCSV">Експорт CSV (time-series)</button>
      <label class="mini"><input id="autoRedraw" type="checkbox" class="checkbox" checked> Автоперемальовування при зміні розміру</label>
    </div>

    <div class="grid2">
      <div>
        <div class="mini muted">PF / GF / SE — конверсії (за період)</div>
        <canvas id="convChart" class="chart" height="228"></canvas>
      </div>
      <div>
        <div class="mini muted">PF / GF / SE — дохід (за період, USD)</div>
        <canvas id="revChart" class="chart" height="228"></canvas>
      </div>
    </div>

    <div class="hr"></div>
    <div class="toolbar" style="gap:8px;align-items:center">
      <div class="mini muted">Мітки: <code>YYYY-MM-DD[:label],YYYY-MM-DD[:label]</code></div>
      <input id="markers" class="in" style="min-width:420px" placeholder="2025-08-20:Launch,2025-08-25:Email"/>
      <button class="btn sec" id="applyMarkers">Apply markers</button>

      <div style="margin-left:auto"></div>
      <div class="mini muted">Експорт по тіру:</div>
      <select id="perTierKind" class="in">
        <option value="orders">orders</option>
        <option value="revenue">revenue</option>
        <option value="conv">conversions</option>
      </select>
      <select id="perTierTier" class="in">
        <option value="all">All tiers</option>
        <option value="PF">PF</option>
        <option value="GF">GF</option>
        <option value="SE">SE</option>
      </select>
      <button class="btn sec" id="exportPerTier">Export per-tier CSV</button>
    </div>

    <div id="chartTip"></div>
  </div>

  <!-- ========================= BULK / EXPORT / BATCH CONVERT ========================= -->
  <div class="card">
    <div class="toolbar" style="gap:10px;flex-wrap:wrap">
      <button id="btnBulkPing" class="btn sec">Позначити як pinged</button>
      <button id="btnBatchConvertOpen" class="btn sec">Batch Convert…</button>
      <div class="hr" style="flex-basis:100%"></div>

      <button id="btnExportVisible" class="btn sec">Експорт видимого (CSV)</button>
      <button id="btnExportSelected" class="btn sec">Експорт обраного (CSV)</button>

      <div class="hr" style="flex-basis:100%"></div>
      <div class="mini muted">Шаблони відповіді (Gmail compose, BCC = вибрані)</div>
      <button id="gmailPaidUA" class="btn ghost pill">Gmail: Paid (UA)</button>
      <button id="gmailPaidEN" class="btn ghost pill">Gmail: Paid (EN)</button>
      <span class="muted">|</span>
      <button id="gmailPingUA" class="btn ghost pill">Gmail: Ping (UA)</button>
      <button id="gmailPingEN" class="btn ghost pill">Gmail: Ping (EN)</button>
      <label class="mini"><input id="excludeGmail" type="checkbox" class="checkbox"/> !exclude gmail.com</label>
      <label class="mini">Chunk BCC
        <select id="bccChunk" class="in"><option>30</option><option>50</option><option>80</option><option>100</option></select>
      </label>
    </div>
  </div>

  <!-- ========================= TABLE ========================= -->
  <div id="tableWrap" class="card" style="padding:0">
    <div class="row" style="padding:10px 12px;gap:10px">
      <span class="mini muted">Tier:</span>
      <select id="fltTier" class="in">
        <option value="">All</option><option>PF</option><option>GF</option><option>SE</option>
      </select>
      <span class="mini muted">Pinged:</span>
      <select id="fltPinged" class="in">
        <option value="">All</option><option value="only">Only pinged</option><option value="not">Only not pinged</option>
      </select>
      <span class="mini muted">Вибрано: <strong id="selCount">0</strong></span>
    </div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th style="width:28px"><input id="checkAll" type="checkbox" class="checkbox"></th>
            <th><span class="thbtn" data-sort="hold_id">hold_id</span></th>
            <th><span class="thbtn" data-sort="email">email</span></th>
            <th><span class="thbtn" data-sort="tier">tier</span></th>
            <th><span class="thbtn" data-sort="batch_id">batch_id</span></th>
            <th><span class="thbtn" data-sort="created_at">створено</span></th>
            <th><span class="thbtn" data-sort="age">вік</span></th>
            <th><span class="thbtn" data-sort="expires_at">діє до</span></th>
            <th>Ping</th>
            <th><span class="thbtn" data-sort="tries">tries</span></th>
            <th>note</th>
            <th class="nowrap">дії</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td class="muted" colspan="12" style="text-align:center;padding:22px">Натисніть “Зберегти & Завантажити”.</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ========================= BATCH CONVERT MODAL ========================= -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Batch Convert</strong>
      <button class="btn ghost pill" id="modalClose">✕</button>
    </div>
    <div class="hr"></div>
    <div class="edit">
      <label class="mini" style="width:110px">Tier</label>
      <select id="bcTier" class="in"><option>PF</option><option selected>GF</option><option>SE</option></select>
    </div>
    <div class="edit" style="margin-top:8px">
      <label class="mini" style="width:110px">Email template</label>
      <input id="bcEmailTmpl" class="in" placeholder="{email}" value="{email}" style="width:260px"/>
    </div>
    <div class="mini muted" style="margin:6px 0 12px">Плейсхолдер <code>{email}</code> заміниться на email рядка. Перевір перед запуском.</div>
    <div class="row">
      <button class="btn primary" id="bcRun">Go</button>
      <span id="bcStatus" class="mini muted"></span>
    </div>
  </div>
</div>

<script>
/* ======================= LocalStorage конфіг ======================= */
const LSKEY = 'admin_holds_cfg_v2';
const DEF = { group:'day', stack:false, avg:true, med:true, ma:'Off', autoRedraw:true, tier:'', pinged:'', q:'' };
function saveCfg(c){ localStorage.setItem(LSKEY, JSON.stringify(c)); }
function loadCfg(){ try{ const x=JSON.parse(localStorage.getItem(LSKEY)||'{}'); return {...DEF, ...x}; }catch{ return {...DEF}; } }
function fillCfgInputs(){
  const cfg = loadCfg();
  edge.value=cfg.EDGE_URL||''; anon.value=cfg.ANON||''; token.value=cfg.TOKEN||'';
  stGroup.value=cfg.group; stStack.checked=cfg.stack; stAvgLine.checked=cfg.avg; stMedLine.checked=cfg.med; stMA.value=cfg.ma; autoRedraw.checked=cfg.autoRedraw;
  fltTier.value=cfg.tier; fltPinged.value=cfg.pinged;
  qInput.value = getURLParam('q') || cfg.q || '';
}

/* ======================= DOM ======================= */
const edge=document.getElementById('edge');
const anon=document.getElementById('anon');
const token=document.getElementById('token');
const minAge=document.getElementById('minAge');
const limitN=document.getElementById('limit');
const saveLoad=document.getElementById('saveLoad');
const reloadBtn=document.getElementById('reload');
const rows=document.getElementById('rows');
const statusEl=document.getElementById('status');
const qInput=document.getElementById('q');
const checkAll=document.getElementById('checkAll');
const selCount=document.getElementById('selCount');

/* filters */
const fltTier=document.getElementById('fltTier');
const fltPinged=document.getElementById('fltPinged');

/* Gmail toolbar */
const gmailPaidUA=document.getElementById('gmailPaidUA');
const gmailPaidEN=document.getElementById('gmailPaidEN');
const gmailPingUA=document.getElementById('gmailPingUA');
const gmailPingEN=document.getElementById('gmailPingEN');
const excludeGmail=document.getElementById('excludeGmail');
const bccChunk=document.getElementById('bccChunk');

/* Bulk/Export buttons */
const btnBulkPing=document.getElementById('btnBulkPing');
const btnExportVisible=document.getElementById('btnExportVisible');
const btnExportSelected=document.getElementById('btnExportSelected');

/* Batch Convert modal */
const modal=document.getElementById('modal'); const modalClose=document.getElementById('modalClose');
const bcTier=document.getElementById('bcTier'); const bcEmailTmpl=document.getElementById('bcEmailTmpl');
const bcRun=document.getElementById('bcRun'); const bcStatus=document.getElementById('bcStatus');
const btnBatchConvertOpen=document.getElementById('btnBatchConvertOpen');

/* Dashboard DOM */
const stFrom=document.getElementById('stFrom');
const stTo=document.getElementById('stTo');
const stReload=document.getElementById('stReload');
const st7=document.getElementById('st7');
const st30=document.getElementById('st30');
const stStatus=document.getElementById('stStatus');
const stHolds=document.getElementById('stHolds');
const stPinged=document.getElementById('stPinged');
const stOrders=document.getElementById('stOrders');
const stRevenue=document.getElementById('stRevenue');
const stConv=document.getElementById('stConv');
const stAvg=document.getElementById('stAvg');
const stAvgAge=document.getElementById('stAvgAge');
const stRange=document.getElementById('stRange');
const stGroup=document.getElementById('stGroup');
const stStack=document.getElementById('stStack');
const stAvgLine=document.getElementById('stAvgLine');
const stMedLine=document.getElementById('stMedLine');
const stMA=document.getElementById('stMA');
const stPNG=document.getElementById('stPNG');
const stCSV=document.getElementById('stCSV');
const autoRedraw=document.getElementById('autoRedraw');
const markersIn=document.getElementById('markers');
const applyMarkers=document.getElementById('applyMarkers');
const perTierKind=document.getElementById('perTierKind');
const perTierTier=document.getElementById('perTierTier');
const exportPerTier=document.getElementById('exportPerTier');

const convChart=document.getElementById('convChart');
const revChart=document.getElementById('revChart');
const chartTip=document.getElementById('chartTip');

/* ======================= Helpers ======================= */
function headers(cfg){ return {'x-admin-token':cfg.TOKEN,'Authorization':`Bearer ${cfg.ANON}`,'apikey':cfg.ANON,'Content-Type':'application/json'}; }
function hmsAgo(iso){ const d=new Date(iso); const ms=Date.now()-d.getTime(); const m=Math.floor(ms/60000), h=Math.floor(m/60), mm=m%60; return { m, label:(h>0?`${h}г `:'')+`${mm}хв` }; }
function fmt(iso){ try{ return new Date(iso).toLocaleString(); }catch{ return iso } }
function copy(txt){ navigator.clipboard.writeText(String(txt)).catch(()=>{}); }
function tag(t){ const cls=t==='PF'?'PF':t==='GF'?'GF':'SE'; return `<span class="tag ${cls}">${t}</span>`; }
function batchToTier(batchId){ if(+batchId===1) return 'PF'; if(+batchId===2) return 'GF'; if(+batchId===5) return 'SE'; return '?'; }
function moneyUSDcents(x){ const v=Number(x||0)/100; return '$'+v.toLocaleString(undefined,{maximumFractionDigits:2}); }
function ymd(d){ return d.toISOString().slice(0,10); }
function download(filename, text){ const a=document.createElement('a'); a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(text); a.download=filename; a.click(); }
function getURLParam(k){ try{ return new URL(location.href).searchParams.get(k) }catch{return null} }
function setURLParam(k, v){ const u=new URL(location.href); if(v) u.searchParams.set(k, v); else u.searchParams.delete(k); history.replaceState(null,'',u.toString()); }

/* ======================= Convert one row ======================= */
const BATCH2TIER={1:'PF',2:'GF',5:'SE'};
async function openConvert(row){
  const cfg=loadCfg(); const EDGE=cfg.EDGE_URL, ANON=cfg.ANON, TOKEN=cfg.TOKEN;
  const tier=BATCH2TIER[row.batch_id]||prompt('Tier (PF/GF/SE):', 'GF');
  const email=prompt('Email:', row.email||''); if(!email||!tier) return;
  const r=await fetch(new URL('/admin-manual-convert', EDGE).toString(),{
    method:'POST',headers:{'content-type':'application/json','x-admin-token':TOKEN,'authorization':`Bearer ${ANON}`,'apikey':ANON},
    body:JSON.stringify({ email, tier, hold_id: row.hold_id, note:'from holds.html' })
  });
  if(!r.ok){ const t=await r.text().catch(()=> ''); alert(`Convert failed: ${r.status}\n${t}`); return; }
  alert('OK — конверт створено');
}

/* ======================= Inline update note/tries ======================= */
async function updateHoldField(hold_id, patch){
  const cfg=loadCfg(); const EDGE=cfg.EDGE_URL, ANON=cfg.ANON, TOKEN=cfg.TOKEN;
  try{
    const r=await fetch(new URL('/admin-update-hold', EDGE).toString(),{
      method:'POST', headers:{'content-type':'application/json','x-admin-token':TOKEN,'authorization':`Bearer ${ANON}`,'apikey':ANON},
      body:JSON.stringify({ hold_id, ...patch })
    });
    if(!r.ok) throw new Error('HTTP '+r.status);
  }catch(e){ console.error('updateHoldField', e); alert('Помилка оновлення'); }
}

/* ======================= Рендер рядка ======================= */
let lastClickedIndex=null;
function renderRow(r, idx){
  const age=hmsAgo(r.created_at); const tier=batchToTier(r.batch_id); const ageCls=age.m>60?'bad':age.m>20?'warn':'ok';
  const tr=document.createElement('tr'); tr.setAttribute('data-hold', r.hold_id);
  tr.innerHTML=`
    <td><input type="checkbox" class="checkbox rowcheck" data-id="${r.hold_id}" data-idx="${idx}"/></td>
    <td><span class="copy" title="Скопіювати" data-copy="${r.hold_id}">${r.hold_id}</span></td>
    <td><span class="copy" title="Скопіювати" data-copy="${r.email}">${r.email}</span></td>
    <td>${tag(tier)}</td>
    <td>${r.batch_id}</td>
    <td>${fmt(r.created_at)}</td>
    <td class="${ageCls}">${age.label}</td>
    <td>${fmt(r.expires_at)}</td>
    <td>${r.chased? '✓ '+fmt(r.chased_at):'—'}</td>
    <td>
      <div class="edit">
        <input type="number" class="in in-tries" value="${Number(r.tries||0)}" min="0" step="1" style="width:72px"/>
      </div>
    </td>
    <td>
      <div class="edit">
        <textarea class="in in-note" placeholder="note…">${r.note||''}</textarea>
      </div>
    </td>
    <td class="nowrap"><button class="btn sec">Convert →</button></td>`;

  tr.querySelectorAll('[data-copy]').forEach(el=> el.addEventListener('click', ()=> copy(el.getAttribute('data-copy'))));
  tr.querySelector('.btn.sec').addEventListener('click', ()=> openConvert(r));

  // shift+click діапазон
  const cb = tr.querySelector('.rowcheck');
  cb.addEventListener('click', (ev)=>{
    const current = Number(cb.dataset.idx);
    if(ev.shiftKey && lastClickedIndex!=null && rows.querySelectorAll('.rowcheck').length){
      const [a,b] = [Math.min(lastClickedIndex,current), Math.max(lastClickedIndex,current)];
      const list=[...rows.querySelectorAll('.rowcheck')];
      for(let i=a;i<=b;i++){ list[i].checked = cb.checked; }
      updateSelectionCount();
      ev.preventDefault();
    }
    lastClickedIndex = current;
    updateSelectionCount();
  });

  // inline tries
  tr.querySelector('.in-tries').addEventListener('change', (e)=>{
    const v=Math.max(0, Number(e.target.value||0)|0);
    e.target.value = v;
    updateHoldField(r.hold_id, { tries:v });
  });

  // inline note (debounced)
  let t=null;
  tr.querySelector('.in-note').addEventListener('input', (e)=>{
    clearTimeout(t);
    const val=e.target.value.slice(0, 2000);
    t=setTimeout(()=> updateHoldField(r.hold_id, { note:val }), 400);
  });

  return tr;
}

/* ======================= Load list ======================= */
let rawList=[];       // як прийшло з бекенду
let filteredList=[];  // після фільтрів
let visibleList=[];   // після пошуку і сортування
let sortState={key:'hold_id', dir:'desc'};
let lastList=[]; // для експорту видимого

async function loadList(){
  const cfg=loadCfg(); if(!cfg.EDGE_URL||!cfg.ANON||!cfg.TOKEN){ statusEl.textContent='Заповніть EDGE_URL, ANON, ADMIN_TOKEN і натисніть “Зберегти & Завантажити”.'; return; }
  statusEl.textContent='Завантажую…'; rows.innerHTML='';
  try{
    const url=new URL('/admin-holds-to-chase', cfg.EDGE_URL);
    url.searchParams.set('min_age', String(Number(minAge.value||10)));
    url.searchParams.set('limit',   String(Number(limitN.value||200)));
    const resp=await fetch(url.toString(), { headers: headers(cfg) });
    if(!resp.ok){ const t=await resp.text().catch(()=> ''); rows.innerHTML=`<tr><td colspan="12" class="bad" style="padding:18px">Помилка ${resp.status}: ${t}</td></tr>`; statusEl.textContent=''; return; }
    rawList=await resp.json(); if(!Array.isArray(rawList)) rawList=[];
    applyFiltersAndRender();
  }catch{ rows.innerHTML=`<tr><td colspan="12" class="bad" style="padding:18px">Помилка мережі</td></tr>`; statusEl.textContent=''; }
}

function applyFiltersAndRender(){
  const cfg=loadCfg();
  // tier / pinged
  filteredList = rawList.filter(r=>{
    if(cfg.tier && batchToTier(r.batch_id)!==cfg.tier) return false;
    if(cfg.pinged==='only' && !r.chased) return false;
    if(cfg.pinged==='not' && r.chased) return false;
    return true;
  });

  // search
  const q=(qInput.value||'').trim().toLowerCase();
  setURLParam('q', q);
  visibleList = !q ? filteredList
    : filteredList.filter(r=> String(r.hold_id).includes(q)||String(r.email||'').toLowerCase().includes(q));

  // sort
  const {key,dir}=sortState;
  const mul = dir==='asc' ? 1 : -1;
  const val = (r)=>{
    if(key==='tier') return batchToTier(r.batch_id);
    if(key==='age'){ const d=new Date(r.created_at); return Date.now()-d.getTime(); }
    return r[key] ?? '';
  };
  visibleList.sort((a,b)=> (val(a)>val(b)?1:-1)*mul);

  // render
  rows.innerHTML='';
  if(!visibleList.length){ rows.innerHTML=`<tr><td colspan="12" class="muted" style="padding:18px;text-align:center">Порожньо.</td></tr>`; }
  else{
    const frag=document.createDocumentFragment();
    visibleList.forEach((r,i)=> frag.appendChild(renderRow(r, i)));
    rows.appendChild(frag);
  }
  lastList = visibleList.slice();
  statusEl.textContent=`Знайдено: ${visibleList.length}`;
  updateSelectionCount();
}

function updateSelectionCount(){
  const n = document.querySelectorAll('.rowcheck:checked').length;
  selCount.textContent = String(n);
}

/* ======================= Bulk ping ======================= */
function selectedIds(){ return Array.from(document.querySelectorAll('.rowcheck:checked')).map(ch=> Number(ch.dataset.id)); }
async function bulkPing(){
  const ids=selectedIds();
  if(!ids.length){ alert('Немає вибраних рядків'); return; }
  const cfg=loadCfg(); const EDGE=cfg.EDGE_URL; const ANON=cfg.ANON; const TOKEN=cfg.TOKEN;
  if(ids.length>200){ alert('Ліміт 200 за раз (захист від помилок)'); return; }
  try{
    const r=await fetch(new URL('/admin-mark-chased-bulk', EDGE).toString(),{
      method:'POST', headers:{'content-type':'application/json','x-admin-token':TOKEN,'authorization':`Bearer ${ANON}`,'apikey':ANON},
      body:JSON.stringify({ ids, mark:true })
    });
    const t=await r.json().catch(()=> ({}));
    if(!r.ok){ alert(`Помилка ${r.status}: ${JSON.stringify(t)}`); return; }
    alert(`Позначено: ${t.updated||0}`);
    loadList();
  }catch{ alert('Помилка мережі'); }
}

/* ======================= Export CSV (visible/selected/per-tier) ======================= */
function listToCSV(list){
  const cols=['hold_id','email','batch_id','created_at','expires_at','chased','chased_at','tries','note'];
  const header=cols.join(',');
  const lines=list.map(r=> cols.map(k=> JSON.stringify(r[k]??'')).join(','));
  return header+'\n'+lines.join('\n');
}
btnExportVisible.onclick=()=>{ if(!lastList.length){ alert('Порожньо'); return; } download('holds-visible.csv', listToCSV(lastList)); };
btnExportSelected.onclick=()=>{ const ids=selectedIds(); const filt=lastList.filter(r=> ids.includes(r.hold_id)); if(!filt.length){ alert('Немає вибраних'); return; } download('holds-selected.csv', listToCSV(filt)); };

exportPerTier.onclick=()=>{
  if(!seriesData){ alert('Немає даних'); return; }
  const p=seriesData.periods; const k=perTierKind.value; const tier=perTierTier.value;
  let cols=['period']; const tiers = tier==='all'? ['PF','GF','SE'] : [tier];
  cols = cols.concat(tiers.map(t=>`${k}_${t}`));
  const lines = p.map((d,i)=>{
    const vals = tiers.map(t=>{
      if(k==='orders'||k==='conv') return (seriesData.conv[t]?.[i]||0);
      if(k==='revenue') return Math.round(seriesData.rev[t]?.[i]||0);
      return 0;
    });
    return [d, ...vals].join(',');
  });
  download(`per-tier_${k}_${tier==='all'?'ALL':tier}_${stFrom.value}_${stTo.value}.csv`, cols.join(',')+'\n'+lines.join('\n'));
};

/* ======================= Gmail compose ======================= */
function openGmail({subject, body}){
  const ids=selectedIds(); const emails=lastList.filter(r=> ids.includes(r.hold_id)).map(r=> String(r.email||'').trim()).filter(Boolean);
  let bcc=emails; if(excludeGmail.checked){ bcc=bcc.filter(e=> !/(@|\.)gmail\.com$/i.test(e)); }
  if(!bcc.length){ alert('Немає email у вибраних'); return; }
  const chunks=[]; const n=Number(bccChunk.value||30); for(let i=0;i<bcc.length;i+=n) chunks.push(bcc.slice(i,i+n));
  chunks.forEach((arr, idx)=>{
    const url=new URL('https://mail.google.com/mail/'); url.searchParams.set('view','cm'); url.searchParams.set('fs','1'); url.searchParams.set('tf','1'); url.searchParams.set('bcc', arr.join(',')); url.searchParams.set('su', subject); url.searchParams.set('body', body);
    setTimeout(()=> window.open(url.toString(), '_blank'), idx*250);
  });
}
const Tmpl={
  paidUA:{subject:'Wislet — Оплату отримано',body:'Вітаю 👋\n\nОтримали ваш лист про оплату. Щоб видати доступ швидше, будь ласка, відповідайте цим листом і надішліть:\n— email, з яким реєструвались на сайті (якщо інший);\n— суму та банк/платіжний сервіс;\n— час платежу або скрін/квитанцію.\n\nПісля підтвердження одразу відкриємо доступ. Якщо натискали на сторінці “Я оплатив — видати доступ”, все ок — ми бачимо цю подію.\n\nДякуємо за підтримку Wislet!\n'},
  paidEN:{subject:'Wislet — Payment received',body:'Hi!\n\nWe\'ve received your “I paid” message. To speed up access, please reply with:\n— the email you used on the site (if different),\n— amount and bank/payment provider,\n— time of payment or a screenshot/receipt.\n\nWe\'ll grant access as soon as we verify it. Thanks for supporting Wislet!\n'},
  pingUA:{subject:'Wislet — уточнення щодо оплати',body:'Вітаю! 👋\n\nБачимо, що ви почали оформлення. Чи все ок з оплатою? Якщо потрібна допомога — просто відповідайте цим листом.\n'},
  pingEN:{subject:'Wislet — quick check-in',body:'Hi! 👋\n\nWe noticed you started checkout. Do you need any help finishing the payment? Just reply to this email.\n'}
};
gmailPaidUA.onclick = ()=> openGmail(Tmpl.paidUA);
gmailPaidEN.onclick = ()=> openGmail(Tmpl.paidEN);
gmailPingUA.onclick = ()=> openGmail(Tmpl.pingUA);
gmailPingEN.onclick = ()=> openGmail(Tmpl.pingEN);

/* ======================= Stats / Dashboard ======================= */
let seriesData=null; // cache
let chartMarkers=[];
function parseMarkers(){ const s=markersIn.value||''; chartMarkers=s.split(',').map(x=>x.trim()).filter(Boolean).map(x=>{ const [d,label]=x.split(':'); return { d, label:(label||'') }; }); }
function setDefaultRange(){ const to=new Date(); const from=new Date(Date.now()-30*24*3600*1000); stFrom.value=ymd(from); stTo.value=ymd(to); }

async function loadStats(){
  const cfg=loadCfg(); if(!cfg.EDGE_URL||!cfg.ANON||!cfg.TOKEN){ stStatus.textContent='(заповніть EDGE/ANON/TOKEN)'; return; }
  stStatus.textContent='Збираю…';
  const url=new URL('/admin-stats', cfg.EDGE_URL);
  url.searchParams.set('from', stFrom.value || ymd(new Date(Date.now()-30*24*3600*1000)));
  url.searchParams.set('to',   stTo.value   || ymd(new Date()));
  url.searchParams.set('group', stGroup.value);
  const r=await fetch(url.toString(), { headers: headers(cfg) }).catch(()=>null);
  if(!r||!r.ok){ stStatus.textContent='Помилка завантаження'; return; }
  const data=await r.json();

  // нормалізація двох форматів API
  seriesData = normalizeSeries(data);
  stHolds.textContent  = (data.counts?.holds ?? '—');
  stPinged.textContent = (data.counts?.pinged ?? '—');
  stOrders.textContent = (data.counts?.orders ?? '—');
  stRevenue.textContent= moneyUSDcents(data.revenue_cents_total||0);
  const conv=data.conversion_after_ping||{};
  stConv.textContent=(conv.rate==null?'—':`${conv.rate}%`)+` (${conv.total_converted||0})`;
  stAvg.textContent= conv.avg_minutes_ping_to_convert==null?'—':String(conv.avg_minutes_ping_to_convert);
  stAvgAge.textContent= (data.kpi_avg_minutes_hold_age_at_convert==null?'—':String(Math.round(data.kpi_avg_minutes_hold_age_at_convert)));
  if(data.range) stRange.textContent=`з ${String(data.range.from||'').slice(0,10)} до ${String(data.range.to||'').slice(0,10)}`;

  drawCharts(); stStatus.textContent='';
}
function normalizeSeries(d){
  if(d.timeseries && d.timeseries.days){ // новий формат
    const days=d.timeseries.days||[];
    const conv={
      PF:(d.timeseries.PF?.conv_after_ping||d.timeseries.PF?.conv||[]),
      GF:(d.timeseries.GF?.conv_after_ping||d.timeseries.GF?.conv||[]),
      SE:(d.timeseries.SE?.conv_after_ping||d.timeseries.SE?.conv||[])
    };
    const rev={
      PF:(d.timeseries.PF?.revenue_cents||[]).map(x=>x/100),
      GF:(d.timeseries.GF?.revenue_cents||[]).map(x=>x/100),
      SE:(d.timeseries.SE?.revenue_cents||[]).map(x=>x/100)
    };
    return { periods:days, conv, rev };
  }
  const s=d.series||{};
  const periods = s.periods || s.labels || [];
  const conv = s.conv || {};
  const revCents = s.rev || s.rev_cents || {};
  return {
    periods,
    conv:{
      PF:Array.isArray(conv.PF)?conv.PF:periods.map(()=>0),
      GF:Array.isArray(conv.GF)?conv.GF:periods.map(()=>0),
      SE:Array.isArray(conv.SE)?conv.SE:periods.map(()=>0),
    },
    rev:{
      PF:(Array.isArray(revCents.PF)?revCents.PF:periods.map(()=>0)).map(x=>x/100),
      GF:(Array.isArray(revCents.GF)?revCents.GF:periods.map(()=>0)).map(x=>x/100),
      SE:(Array.isArray(revCents.SE)?revCents.SE:periods.map(()=>0)).map(x=>x/100),
    }
  };
}

/* ===== ресайз canvas під контейнер (CSS width:100%) ===== */
function resizeCanvasTo(el){
  const w = el.parentElement?.clientWidth || 520;
  const cssH = parseInt(el.getAttribute('height')||'220', 10);
  el.style.width = w + 'px';
  el.style.height = cssH + 'px';
  el.width = w;
  el.height = cssH;
}

function drawCharts(){
  if(!seriesData) return;
  resizeCanvasTo(convChart); resizeCanvasTo(revChart);
  const periods=seriesData.periods||[];
  const conv=seriesData.conv||{PF:[],GF:[],SE:[]};
  const rev =seriesData.rev ||{PF:[],GF:[],SE:[]};
  const stacked=stStack.checked;
  drawTimeChart(convChart,{ periods, series:[{name:'PF',data:conv.PF,color:'#06b6d4'},{name:'GF',data:conv.GF,color:'#fde047'},{name:'SE',data:conv.SE,color:'#cbd5e1'}], stacked, yLabel:'conversions', kind:'bar' });
  const maWin=stMA.value==='Off'?0:Number(stMA.value);
  drawTimeChart(revChart,{ periods, series:[{name:'PF',data:rev.PF,color:'#06b6d4'},{name:'GF',data:rev.GF,color:'#fde047'},{name:'SE',data:rev.SE,color:'#cbd5e1'}], stacked:false, yLabel:'revenue, $', kind:'line', avgLine: stAvgLine.checked, medLine: stMedLine.checked, maWindow:maWin, markers:chartMarkers });
}

function drawTimeChart(canvas,{periods,series,stacked=false,yLabel='',kind='line',avgLine=false,medLine=false,maWindow=0,markers=[]}){
  const ctx=canvas.getContext('2d'); const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H);
  const padL=46, padR=16, padT=12, padB=28; const plotW=W-padL-padR, plotH=H-padT-padB;
  const n=periods.length; const step= n>1 ? plotW/(n-1) : plotW; const xs=periods.map((_,i)=> padL + i*step);
  const maxY = (()=> {
    if (kind==='bar' && stacked) return Math.max(1, ...periods.map((_,i)=> series.reduce((t,s)=> t + (s.data[i]||0), 0)));
    return Math.max(1, ...series.flatMap(s=> s.data));
  })();
  const yToPx=(v)=> padT + plotH - (v/maxY)*plotH;

  // grid + axes
  ctx.strokeStyle='#1f2736'; ctx.lineWidth=1; ctx.beginPath(); for(let i=0;i<5;i++){ const y=padT + i*plotH/4; ctx.moveTo(padL,y); ctx.lineTo(W-padR,y);} ctx.stroke();
  ctx.fillStyle='#94a3b8'; ctx.fillRect(padL, H-padB, plotW, 1);
  ctx.font='12px Inter,system-ui'; ctx.fillText(yLabel, 6, padT+12);

  // markers
  if(markers && markers.length){
    ctx.save(); ctx.strokeStyle='rgba(239,68,68,.6)'; ctx.fillStyle='rgba(239,68,68,.8)'; ctx.lineWidth=1;
    markers.forEach(m=>{ const idx=periods.indexOf(m.d); if(idx>=0){ const x=xs[idx]; ctx.beginPath(); ctx.moveTo(x, padT); ctx.lineTo(x, H-padB); ctx.stroke(); if(m.label){ ctx.fillText(m.label, x+4, padT+12); } } });
    ctx.restore();
  }

  if(kind==='bar'){
    const barW = step * 0.7 / (stacked?1:series.length);
    series.forEach((s, si)=>{
      ctx.fillStyle = s.color;
      for(let i=0;i<n;i++){
        const v=s.data[i]||0; const x=xs[i] - (stacked? barW/2 : ( (series.length*barW)/2 - si*barW - barW/2) );
        if(stacked){
          const sumPrev=series.slice(0,si).reduce((t,pr)=> t+(pr.data[i]||0),0);
          const y0=yToPx(sumPrev+v); const y1=yToPx(sumPrev);
          ctx.fillRect(x, y0, barW, Math.max(1,y1-y0));
        } else {
          const h=plotH * (v/maxY); const y= padT + plotH - h;
          ctx.fillRect(x, y, barW, Math.max(1,h));
        }
      }
    });
  } else {
    // lines
    series.forEach(s=>{ ctx.strokeStyle=s.color; ctx.lineWidth=2; ctx.beginPath(); for(let i=0;i<n;i++){ const v=s.data[i]||0; const x=xs[i]; const y=yToPx(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.stroke(); });

    // moving average band 7..28 + 14 line (по total)
    if(maWindow>0){
      const totals=periods.map((_,i)=> series.reduce((t,s)=> t+(s.data[i]||0),0));
      const avg=(w)=> totals.map((_,i)=>{ const a=Math.max(0,i-w+1); const b=i+1; const slice=totals.slice(a,b); return slice.reduce((t,x)=>t+x,0)/slice.length; });
      const m7=avg(7), m14=avg(14), m28=avg(28);
      ctx.save(); ctx.fillStyle='rgba(125,211,252,0.15)'; ctx.beginPath(); for(let i=0;i<n;i++){ const x=xs[i]; const y=yToPx(Math.max(m7[i]||0, m28[i]||0)); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} for(let i=n-1;i>=0;i--){ const x=xs[i]; const y=yToPx(Math.min(m7[i]||0, m28[i]||0)); ctx.lineTo(x,y);} ctx.closePath(); ctx.fill(); ctx.restore();
      ctx.save(); ctx.strokeStyle='#7dd3fc'; ctx.setLineDash([4,3]); ctx.beginPath(); for(let i=0;i<n;i++){ const x=xs[i]; const y=yToPx(m14[i]||0); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.stroke(); ctx.setLineDash([]); ctx.restore();
    }

    // avg / median (по всіх точках усіх серій)
    const all=series.reduce((acc,s)=> acc.concat(s.data), []);
    const avgv= all.reduce((t,x)=>t+x,0) / Math.max(1, all.length);
    const med= (()=>{ const a=[...all].sort((a,b)=>a-b); const m=Math.floor(a.length/2); return a.length? (a.length%2? a[m] : (a[m-1]+a[m])/2) : 0; })();
    ctx.save();
    if(avgLine){ ctx.strokeStyle='rgba(34,211,238,.6)'; ctx.beginPath(); const y=yToPx(avgv); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke(); }
    if(medLine){ ctx.strokeStyle='rgba(250,204,21,.6)'; ctx.beginPath(); const y=yToPx(med); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke(); }
    ctx.restore();
  }

  // x labels
  ctx.fillStyle='#94a3b8'; ctx.font='12px Inter,system-ui'; const every=Math.max(1, Math.floor(n/8));
  periods.forEach((p,i)=>{ if(i%every===0||i===n-1){ const x=xs[i]; ctx.fillText(p.slice(5), x-16, H-8); } });

  // tooltips
  canvas.onmousemove=(ev)=>{
    const r=canvas.getBoundingClientRect(); const x=ev.clientX-r.left; const y=ev.clientY-r.top;
    if(x<padL||x>W-padR||y<padT||y>H-padB){ chartTip.style.display='none'; return; }
    const idx=Math.round((x-padL)/step); const i=Math.max(0,Math.min(n-1,idx));
    if(kind==='bar'){
      const rows=series.map(s=> `${s.name}: ${s.data[i]||0}`); const total=series.reduce((t,s)=>t+(s.data[i]||0),0);
      chartTip.innerHTML = `<div style="opacity:.8">${periods[i]}</div>`+rows.join('<br/>')+`<div style="margin-top:4px;opacity:.8">Total: ${total}</div>`;
    }else{
      const rows=series.map(s=> `${s.name}: $${Math.round(s.data[i]||0)}`); const total=series.reduce((t,s)=>t+(s.data[i]||0),0);
      chartTip.innerHTML = `<div style="opacity:.8">${periods[i]}</div>`+rows.join('<br/>')+`<div style="margin-top:4px;opacity:.8">Total: $${Math.round(total)}</div>`;
    }
    chartTip.style.left=(ev.clientX+12)+'px'; chartTip.style.top=(ev.clientY+12)+'px'; chartTip.style.display='block';
  };
  canvas.onmouseleave=()=>{ chartTip.style.display='none'; };
}

/* ===== події/пресети для статистики ===== */
stReload.onclick=loadStats;
st7.onclick =()=>{ const to=new Date(); const from=new Date(Date.now()-7*24*3600*1000); stFrom.value=ymd(from); stTo.value=ymd(to); loadStats(); };
st30.onclick=()=>{ const to=new Date(); const from=new Date(Date.now()-30*24*3600*1000); stFrom.value=ymd(from); stTo.value=ymd(to); loadStats(); };
stGroup.onchange=()=>{ const cfg=loadCfg(); cfg.group=stGroup.value; saveCfg(cfg); loadStats(); };
stStack.onchange=()=>{ const cfg=loadCfg(); cfg.stack=stStack.checked; saveCfg(cfg); drawCharts(); };
stAvgLine.onchange=()=>{ const cfg=loadCfg(); cfg.avg=stAvgLine.checked; saveCfg(cfg); drawCharts(); };
stMedLine.onchange=()=>{ const cfg=loadCfg(); cfg.med=stMedLine.checked; saveCfg(cfg); drawCharts(); };
stMA.onchange=()=>{ const cfg=loadCfg(); cfg.ma=stMA.value; saveCfg(cfg); drawCharts(); };
applyMarkers.onclick=()=>{ parseMarkers(); drawCharts(); };
stPNG.onclick=()=>{ const fnBase=`stats_${stFrom.value||'from'}_${stTo.value||'to'}`; const a1=document.createElement('a'); a1.href=convChart.toDataURL('image/png'); a1.download=`${fnBase}_conversions.png`; a1.click(); const a2=document.createElement('a'); a2.href=revChart.toDataURL('image/png'); a2.download=`${fnBase}_revenue.png`; a2.click(); };
stCSV.onclick=()=>{ if(!seriesData){ alert('Немає даних'); return; } const p=seriesData.periods; const conv=seriesData.conv; const rev=seriesData.rev; const cols=['period','conv_PF','conv_GF','conv_SE','rev_PF','rev_GF','rev_SE']; const lines=p.map((d,i)=> [d, conv.PF[i]||0, conv.GF[i]||0, conv.SE[i]||0, Math.round(rev.PF[i]||0), Math.round(rev.GF[i]||0), Math.round(rev.SE[i]||0)].join(',')); download(`timeseries_${stFrom.value}_${stTo.value}.csv`, cols.join(',')+'\n'+lines.join('\n')); };
window.addEventListener('resize', ()=>{ const cfg=loadCfg(); if(cfg.autoRedraw) drawCharts(); });

/* ======================= Quick select chips ======================= */
document.querySelectorAll('[data-qsel]').forEach(b=>{
  b.addEventListener('click', ()=>{
    const type=b.dataset.qsel;
    const list=[...rows.querySelectorAll('.rowcheck')];
    list.forEach(el=> el.checked=false);
    if(type==='all') list.forEach(el=> el.checked=true);
    if(['pf','gf','se','pinged','notpinged'].includes(type)){
      visibleList.forEach((r, i)=>{
        const el=list[i];
        if(type==='pf' && batchToTier(r.batch_id)==='PF') el.checked=true;
        if(type==='gf' && batchToTier(r.batch_id)==='GF') el.checked=true;
        if(type==='se' && batchToTier(r.batch_id)==='SE') el.checked=true;
        if(type==='pinged' && r.chased) el.checked=true;
        if(type==='notpinged' && !r.chased) el.checked=true;
      });
    }
    document.querySelectorAll('.qs .btn.ghost').forEach(x=>x.classList.remove('active'));
    if(type!=='clear') b.classList.add('active');
    updateSelectionCount();
  });
});

/* ======================= Sorting ======================= */
document.querySelectorAll('thead .thbtn').forEach(th=>{
  th.addEventListener('click', ()=>{
    const key=th.dataset.sort;
    if(sortState.key===key){ sortState.dir = (sortState.dir==='asc'?'desc':'asc'); }
    else { sortState.key=key; sortState.dir='asc'; }
    applyFiltersAndRender();
  });
});

/* ======================= Фільтри tier/pinged ======================= */
fltTier.onchange=()=>{ const cfg=loadCfg(); cfg.tier=fltTier.value||''; saveCfg(cfg); applyFiltersAndRender(); };
fltPinged.onchange=()=>{ const cfg=loadCfg(); cfg.pinged=fltPinged.value||''; saveCfg(cfg); applyFiltersAndRender(); };

/* ======================= Пошук (debounce) ======================= */
let qT=null;
qInput.addEventListener('input', ()=>{
  const cfg=loadCfg(); cfg.q=qInput.value; saveCfg(cfg);
  clearTimeout(qT); qT=setTimeout(()=> applyFiltersAndRender(), 250);
});

/* ======================= Batch Convert modal ======================= */
btnBatchConvertOpen.onclick=()=> modal.classList.add('show');
modalClose.onclick=()=> modal.classList.remove('show');
modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('show'); });

bcRun.onclick=async ()=>{
  const ids=selectedIds();
  if(!ids.length){ alert('Немає вибраних'); return; }
  const cfg=loadCfg(); const EDGE=cfg.EDGE_URL; const ANON=cfg.ANON; const TOKEN=cfg.TOKEN;
  const tier=bcTier.value; const tmpl=bcEmailTmpl.value||'{email}';
  bcStatus.textContent='Працюю…';
  let ok=0, fail=0;
  for(const id of ids){
    const rec = visibleList.find(x=> x.hold_id===id) || rawList.find(x=> x.hold_id===id);
    const email=(tmpl||'{email}').replace('{email}', rec?.email||'');
    try{
      const r=await fetch(new URL('/admin-manual-convert', EDGE).toString(),{
        method:'POST',headers:{'content-type':'application/json','x-admin-token':TOKEN,'authorization':`Bearer ${ANON}`,'apikey':ANON},
        body:JSON.stringify({ email, tier, hold_id:id, note:'batch from holds.html' })
      });
      if(r.ok) ok++; else fail++;
    }catch{ fail++; }
    await new Promise(rs=> setTimeout(rs, 120)); // легкий тротлінг
    bcStatus.textContent=`ok ${ok} / fail ${fail}`;
  }
  bcStatus.textContent=`Готово: ok ${ok} • fail ${fail}`;
};

/* ======================= Гарячі клавіші ======================= */
document.addEventListener('keydown',(e)=>{
  if(['INPUT','TEXTAREA','SELECT'].includes((e.target?.tagName||'').toUpperCase())) return;
  if(e.key==='a'||e.key==='A'){ checkAll.checked=true; document.querySelectorAll('.rowcheck').forEach(ch=> ch.checked=true); updateSelectionCount(); }
  if(e.key==='p'||e.key==='P'){ bulkPing(); }
  if(e.key==='c'||e.key==='C'){ modal.classList.add('show'); }
});

/* ======================= Init / bindings ======================= */
function onSaveLoad(){ const cfg=loadCfg(); saveCfg({ ...cfg, EDGE_URL:edge.value.trim(), ANON:anon.value.trim(), TOKEN:token.value.trim() }); loadList(); loadStats(); }
saveLoad.onclick=onSaveLoad;
reloadBtn.onclick=loadList;
checkAll.addEventListener('change', ()=>{ document.querySelectorAll('.rowcheck').forEach(ch=> ch.checked=checkAll.checked); updateSelectionCount(); });
btnBulkPing.addEventListener('click', bulkPing);

(function init(){
  fillCfgInputs();
  const cfg=loadCfg(); if(cfg.q) setURLParam('q', cfg.q);
  setDefaultRange(); parseMarkers();
  const paramsQ = getURLParam('q'); if(paramsQ){ qInput.value=paramsQ; const cfg2=loadCfg(); cfg2.q=paramsQ; saveCfg(cfg2); }
  if(cfg.EDGE_URL&&cfg.ANON&&cfg.TOKEN){ loadList(); loadStats(); }
})();
</script>
</body>
</html>
